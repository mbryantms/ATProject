(()=>{(function(){"use strict";let t={config:{containerSelector:"#markdownBody",citationSelector:"a.footnote-ref",footnoteSelector:"li.footnote",sidenoteSpacing:60,sidenotePadding:13,minimumViewportWidthForSidenotes:1761,minimumViewportWidthForSidenoteMarginNotes:1497,useLeftColumn:!1,useRightColumn:!0,potentiallyOverlappingElementsSelectors:[".width-full img",".width-full video",".width-full .caption-wrapper",".width-full table",".width-full pre",".marginnote"],constrainMarginNotesWithinSelectors:[".backlink-context",".margin-notes-block",".footnote",".sidenote > *"]},sidenotes:null,citations:null,sidenoteColumnLeft:null,sidenoteColumnRight:null,positionUpdateQueued:!1,mediaQueries:{},DEBUG:!1,log:(e,i=2)=>{if(!console)return;let d=t.DEBUG?99:1;i>d||(i===0?console.error(`[Sidenotes] ${e}`):i===1?console.warn(`[Sidenotes] ${e}`):console.log(`[Sidenotes] ${e}`))},newElement:(e,i={},d={})=>{let u=document.createElement(e);return Object.entries(i).forEach(([s,f])=>{s==="class"?u.className=Array.isArray(f)?f.join(" "):f:u.setAttribute(s,f)}),Object.entries(d).forEach(([s,f])=>{u[s]=f}),u},noteNumber:e=>{var d;if(!e)return null;let i=(d=e.id)==null?void 0:d.match(/(?:fnref|fn|sn)(\d+)/);return i?i[1]:null},footnoteIdForNumber:e=>`fn${e}`,sidenoteIdForNumber:e=>`sn${e}`,citationIdForNumber:e=>`fnref${e}`,sidenoteOfNumber:e=>{var i,d;return(d=(i=t.sidenotes)==null?void 0:i.find(u=>t.noteNumber(u)==e))!=null?d:null},citationOfNumber:e=>{var i,d;return(d=(i=t.citations)==null?void 0:i.find(u=>t.noteNumber(u)==e))!=null?d:null},counterpart:e=>{if(!e)return null;let i=t.noteNumber(e);return e.classList.contains("sidenote")?t.citationOfNumber(i):t.sidenoteOfNumber(i)},isWithinCollapsedBlock:e=>!1,updateSidenotePositionsIfNeeded:()=>{!t.sidenoteColumnLeft&&!t.sidenoteColumnRight||t.positionUpdateQueued||(t.positionUpdateQueued=!0,requestIdleCallback(()=>{t.positionUpdateQueued=!1,t.updateSidenotePositions()}))},updateSidenoteDispositions:()=>{let e=t.config;for(let[i,d]of t.sidenotes.entries()){d.classList.toggle("hidden",t.isWithinCollapsedBlock(t.citations[i]));let u=parseInt(t.noteNumber(d)),s=null;e.useLeftColumn&&!e.useRightColumn?s=t.sidenoteColumnLeft:!e.useLeftColumn&&e.useRightColumn?s=t.sidenoteColumnRight:e.useLeftColumn&&e.useRightColumn&&(s=u%2?t.sidenoteColumnLeft:t.sidenoteColumnRight),d.parentElement!=s&&s&&s.append(d)}},updateSidenotePositions:()=>{t.log("updateSidenotePositions",2);let e=t.config;if(!t.mediaQueries.viewportWidthBreakpoint.matches)return;t.updateSidenoteDispositions();let i=t.sidenoteColumnLeft.getBoundingClientRect(),d=t.sidenoteColumnRight.getBoundingClientRect(),u=[],s=[];document.querySelectorAll(e.potentiallyOverlappingElementsSelectors.join(", ")).forEach(o=>{if(t.isWithinCollapsedBlock(o))return;let r=o.getBoundingClientRect();r.left>i.right||r.right<i.left||u.push({top:r.top-e.sidenoteSpacing-i.top,bottom:r.bottom+e.sidenoteSpacing-i.top,element:o}),r.left>d.right||r.right<d.left||s.push({top:r.top-e.sidenoteSpacing-d.top,bottom:r.bottom+e.sidenoteSpacing-d.top,element:o})}),u.push({top:t.sidenoteColumnLeft.clientHeight,bottom:t.sidenoteColumnLeft.clientHeight}),s.push({top:t.sidenoteColumnRight.clientHeight,bottom:t.sidenoteColumnRight.clientHeight}),[u,s].forEach(o=>{o.sort((r,a)=>r.top-a.top);for(let r=0;r<o.length-1;r++){let a=o[r],m=o[r+1];m.top<=a.bottom&&(a.bottom=m.bottom,o.splice(r+1,1),r++)}}),t.sidenotes.forEach(o=>{let r=o.firstElementChild;o.classList.toggle("cut-off",r.scrollHeight>r.offsetHeight+2)});let f=[],L=[];e.useLeftColumn&&L.push([t.sidenoteColumnLeft,i,u]),e.useRightColumn&&L.push([t.sidenoteColumnRight,d,s]),L.forEach(o=>{let[r,a,m]=o,n=0;m.forEach(l=>{f.push({sidenotes:[],column:r,columnRect:a,left:a.left,right:a.right,width:a.width,top:a.top+n,bottom:a.top+l.top,height:l.top-n,room:l.top-n}),n=l.bottom})});let C=(o,r)=>Math.max(0,Math.round(r.getBoundingClientRect().top-o.top+4));for(let[o,r]of t.citations.entries()){let a=t.sidenotes[o];if(a.classList.contains("hidden"))continue;let m=f.filter(p=>p.room>=a.offsetHeight);if(m.length==0){t.log("Too many sidenotes - cannot fit all",1),t.sidenotes.forEach(p=>p.remove());return}let n=r.getBoundingClientRect(),l=p=>n.top>p.top&&n.top<p.bottom?0:n.top<p.top?Math.abs(n.top-p.top):Math.abs(n.top-p.bottom),h=p=>Math.abs(n.left-(p.left+p.width/2)),g=(p,b)=>{let w=C(p,r),N=t.counterpart(b),y=C(p,N);return y>w+a.offsetHeight+e.sidenoteSpacing||w>y+b.offsetHeight+e.sidenoteSpacing?0:Math.max(w+a.offsetHeight+e.sidenoteSpacing-y,y+b.offsetHeight+e.sidenoteSpacing-w)},S=p=>p.sidenotes.reduce((b,w)=>b+g(p,w),0);m.sort((p,b)=>l(p)+S(p)-(l(b)+S(b))||h(p)-h(b));let v=m[0];v.room-=a.offsetHeight+e.sidenoteSpacing,v.sidenotes.push(a)}let c=(o,r)=>r.posInCell-(o.posInCell+o.offsetHeight+e.sidenoteSpacing);f.forEach(o=>{if(o.sidenotes.length==0)return;o.sidenotes.forEach(n=>{let l=t.counterpart(n);n.posInCell=C(o,l)}),o.sidenotes.sort((n,l)=>n.posInCell-l.posInCell||parseInt(n.id.slice(2))-parseInt(l.id.slice(2)));let r=(n,l)=>{n.forEach(h=>{o.sidenotes[h].posInCell-=l})},a=(n,l,h=!1)=>{let g=n[0]==0?o.sidenotes[n[0]].posInCell:Math.max(0,c(o.sidenotes[n[0]-1],o.sidenotes[n[0]])),S=h?l:Math.floor(l/n.length);return S<=g?(r(n,S),l-S):(r(n,g),n[0]==0?l-g:(n.splice(0,0,n[0]-1),a(n,l-g,h)))};for(let n=1;n<o.sidenotes.length;n++){let l=o.sidenotes[n-1],h=o.sidenotes[n],g=Math.max(0,-1*c(l,h));if(g==0)continue;let S=Math.round(g/2);h.posInCell+=g-S+a([n-1],S)}let m=Math.max(0,o.sidenotes[o.sidenotes.length-1].posInCell+o.sidenotes[o.sidenotes.length-1].offsetHeight-o.height);m>0&&a([o.sidenotes.length-1],m,!0),o.sidenotes.forEach(n=>{n.style.top=Math.round(n.posInCell)+(o.top-o.columnRect.top)+"px"})}),t.sidenoteColumnLeft.style.visibility="",t.sidenoteColumnRight.style.visibility=""},adjustSidenotePositionOnHover:e=>{let i=window.innerHeight,d=e.getBoundingClientRect(),u=e.querySelector(".sidenote-outer-wrapper");if(!u)return;let s=u.scrollHeight,f=d.top,L=d.bottom;if(e.dataset.originalTop||(e.dataset.originalTop=e.style.top),f<0){let C=Math.abs(f),o=(parseFloat(e.style.top)||0)+C+20;e.style.top=o+"px",e.style.transition="top 0.2s ease-out",e.classList.add("position-adjusted");return}if(L>i){let C=L-i,c=parseFloat(e.style.top)||0,o=c-C-20;if(d.top-C-20>=0)e.style.top=o+"px",e.style.transition="top 0.2s ease-out",e.classList.add("position-adjusted");else{let a=d.top-20;e.style.top=c-a+"px",e.style.transition="top 0.2s ease-out",e.classList.add("position-adjusted")}}},resetSidenotePosition:e=>{e.dataset.originalTop&&(e.style.top=e.dataset.originalTop,e.style.transition="top 0.2s ease-out",e.classList.remove("position-adjusted"),setTimeout(()=>{e.classList.contains("position-adjusted")||(e.style.transition="")},200))},deconstructSidenotes:()=>{t.log("deconstructSidenotes",2),t.sidenotes=null,t.citations=null,t.sidenoteColumnLeft&&(t.sidenoteColumnLeft.remove(),t.sidenoteColumnLeft=null),t.sidenoteColumnRight&&(t.sidenoteColumnRight.remove(),t.sidenoteColumnRight=null)},constructSidenotes:()=>{t.log("constructSidenotes",2);let e=t.config,i=document.querySelector(e.containerSelector);if(!i){t.log("Container not found: "+e.containerSelector,0);return}!t.sidenoteColumnLeft&&!t.sidenoteColumnRight&&(t.sidenoteColumnLeft=t.newElement("DIV",{id:"sidenote-column-left",class:"footnotes sidenote-column"}),t.sidenoteColumnLeft.style.visibility="hidden",t.sidenoteColumnRight=t.newElement("DIV",{id:"sidenote-column-right",class:"footnotes sidenote-column"}),t.sidenoteColumnRight.style.visibility="hidden",i.append(t.sidenoteColumnLeft),i.append(t.sidenoteColumnRight),t.sidenotes=[],t.citations=[]);let u=Array.from(document.querySelectorAll(e.citationSelector)).filter(s=>t.citationOfNumber(t.noteNumber(s))==null);u.length!=0&&(t.citations.push(...u),t.citations.sort((s,f)=>t.noteNumber(s)-t.noteNumber(f)),t.sidenotes.forEach(s=>s.remove()),t.sidenotes=[],t.citations.forEach(s=>{let f=t.noteNumber(s),L=t.footnoteIdForNumber(f),C=document.getElementById(L);if(!C){t.log(`Footnote ${L} not found for citation`,1);return}let c=t.newElement("DIV",{class:"sidenote",id:t.sidenoteIdForNumber(f)});c.style.visibility="hidden";let o=t.newElement("DIV",{class:"sidenote-outer-wrapper"}),r=t.newElement("DIV",{class:"sidenote-inner-wrapper"});o.appendChild(r),c.appendChild(o);let a=t.newElement("A",{class:"sidenote-self-link",href:"#"+t.sidenoteIdForNumber(f)},{textContent:f});c.appendChild(a);let m=C.cloneNode(!0);Array.from(m.childNodes).filter(l=>l.nodeType===Node.ELEMENT_NODE?!l.classList.contains("footnote-self-link"):!0).forEach(l=>r.appendChild(l)),t.sidenotes.push(c),c.addEventListener("mouseenter",()=>{s.classList.add("highlighted"),c.classList.add("highlighted","hovering"),t.adjustSidenotePositionOnHover(c)}),c.addEventListener("mouseleave",()=>{s.classList.remove("highlighted"),c.classList.remove("highlighted","hovering"),t.resetSidenotePosition(c)}),s.addEventListener("mouseenter",()=>{s.classList.add("highlighted"),c.classList.add("highlighted","hovering"),t.adjustSidenotePositionOnHover(c)}),s.addEventListener("mouseleave",()=>{s.classList.remove("highlighted"),c.classList.remove("highlighted","hovering"),t.resetSidenotePosition(c)}),s.addEventListener("click",l=>{if(t.mediaQueries.viewportWidthBreakpoint.matches){l.preventDefault();let h=t.sidenoteIdForNumber(f);history.pushState(null,"","#"+h);let g=t.config.sidenotePadding,S=c.getBoundingClientRect(),v=window.scrollY+S.top-g-10;window.scrollTo({top:v,behavior:"smooth"}),c.classList.add("targeted"),setTimeout(()=>{c.classList.remove("targeted")},2e3)}})}),t.updateSidenoteDispositions(),requestAnimationFrame(()=>{t.updateSidenotePositions(),t.sidenotes.forEach(s=>{s.style.visibility=""})}))},updateMarginNoteStyle:()=>{let e=t.config;document.querySelectorAll(".marginnote").forEach(i=>{i.closest(e.constrainMarginNotesWithinSelectors.join(", "))||!t.mediaQueries.marginNoteViewportWidthBreakpoint.matches?(i.classList.remove("sidenote"),i.classList.add("inline")):(i.classList.remove("inline"),i.classList.add("sidenote"))})},setup:()=>{t.log("setup",2);let e=t.config;t.mediaQueries.viewportWidthBreakpoint=matchMedia(`(min-width: ${e.minimumViewportWidthForSidenotes}px)`),t.mediaQueries.marginNoteViewportWidthBreakpoint=matchMedia(`(min-width: ${e.minimumViewportWidthForSidenoteMarginNotes}px)`);let i=f=>{f.matches?t.constructSidenotes():t.deconstructSidenotes()};t.mediaQueries.viewportWidthBreakpoint.addListener(i);let d=()=>{t.updateMarginNoteStyle()};t.mediaQueries.marginNoteViewportWidthBreakpoint.addListener(d),t.mediaQueries.viewportWidthBreakpoint.matches&&t.constructSidenotes(),t.updateMarginNoteStyle();let u;window.addEventListener("resize",()=>{clearTimeout(u),u=setTimeout(()=>{t.mediaQueries.viewportWidthBreakpoint.matches&&t.updateSidenotePositionsIfNeeded()},100)});let s;window.addEventListener("scroll",()=>{clearTimeout(s),s=setTimeout(()=>{t.mediaQueries.viewportWidthBreakpoint.matches&&t.updateSidenotePositionsIfNeeded()},150)},{passive:!0}),t.log("setup complete",2)},init:(e={})=>{Object.assign(t.config,e),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{t.setup()}):t.setup()}};window.SidenotesStandalone=t,t.init()})();})();
